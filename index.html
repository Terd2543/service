<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเช็คชื่อนักเรียน ม.1/10</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl">
        <h1 class="text-3xl font-bold text-center text-purple-800 mb-4">ระบบเช็คชื่อนักเรียน ม.1/10</h1>
        <p class="text-center text-gray-600 mb-6 text-lg">วันที่ <span id="currentDate" class="font-semibold text-purple-700"></span></p>

        <div class="overflow-x-auto mb-6">
            <table class="min-w-full bg-white rounded-lg shadow-md">
                <thead class="bg-purple-600 text-white">
                    <tr>
                        <th class="py-3 px-4 text-left text-sm font-semibold rounded-tl-lg">ลำดับ</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold">ชื่อนักเรียน</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold rounded-tr-lg">สถานะ</th>
                    </tr>
                </thead>
                <tbody id="studentList" class="divide-y divide-gray-200">
                    <!-- Student rows will be injected here by JavaScript -->
                    <tr>
                        <td colspan="3" class="text-center py-4 text-gray-500">กำลังโหลดรายชื่อนักเรียน...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button id="confirmButton"
                class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:from-purple-700 hover:to-indigo-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300">
            ยืนยันการเช็คชื่อและแจ้งเตือน LINE
        </button>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full text-center">
            <h3 id="modalTitle" class="text-xl font-bold mb-4 text-gray-800"></h3>
            <p id="modalMessage" class="text-gray-700 mb-6"></p>
            <button id="modalCloseButton" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 transition duration-200">
                ตกลง
            </button>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        // *** สำคัญ: แทนที่ค่า YOUR_..._HERE ด้วยข้อมูลจริงจาก Firebase Console ของคุณ ***
        // ไปที่ Firebase Console -> Project settings -> Your apps -> เลือก Web app ของคุณ
        const firebaseConfig = {
  apiKey: "AIzaSyCFgeVSJrziYLDToRja4r5B3HOGfvvmGfM",
  authDomain: "service-b6c91.firebaseapp.com",
  projectId: "service-b6c91",
  storageBucket: "service-b6c91.firebasestorage.app",
  messagingSenderId: "373682783124",
  appId: "1:373682783124:web:f7a28733a95247e69b8581",
  measurementId: "G-8WTMWP04HG"
};

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 2. Backend API URL
        // *** สำคัญ: เปลี่ยนเป็น Public URL ของ Render Backend ของคุณ (ไม่มี /api หรือ /webhook ต่อท้าย) ***
        // ตัวอย่าง: 'https://backend-1ghl.onrender.com'
        const BACKEND_API_BASE_URL = 'https://backend-1ghl.onrender.com'; 

        // ตัวแปรสำหรับเก็บข้อมูลนักเรียนและสถานะการเช็คชื่อ
        let studentsData = [];
        // attendanceStatus จะเก็บ status และ checkIns array (แต่ checkIns จะไม่แสดงผลใน UI)
        const attendanceStatus = {}; // { studentId: { status: 'มา/ลา/ขาด/สาย', checkIns: ['HH:MM', ...] } }

        // Elements
        const studentListTableBody = document.getElementById('studentList');
        const confirmButton = document.getElementById('confirmButton');
        const currentDateSpan = document.getElementById('currentDate');
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseButton = document.getElementById('modalCloseButton');

        // Helper function to get today's date in YYYY-MM-DD format
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Helper function to get current time in HH:MM format
        function getCurrentTimeString() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Display custom modal
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            customModal.classList.remove('hidden');
        }

        // Hide custom modal
        function hideModal() {
            customModal.classList.add('hidden');
        }

        // Event listener for modal close button
        modalCloseButton.addEventListener('click', hideModal);

        // Function to fetch students from Firestore and their attendance for today
        async function fetchStudents() {
            studentListTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">กำลังโหลดรายชื่อนักเรียน...</td></tr>';
            const todayDate = getTodayDateString();

            try {
                // Fetch all students from Firestore
                const studentsCol = collection(db, 'students');
                // Query students for 'ม.1/10' class
                const qStudents = query(studentsCol, where('class', '==', 'ม.1/10'));
                const studentSnapshot = await getDocs(qStudents); 

                if (studentSnapshot.empty) {
                    studentListTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500">ไม่พบรายชื่อนักเรียนในชั้น ม.1/10 ในฐานข้อมูล Firebase. โปรดเพิ่มนักเรียนก่อน.</td></tr>';
                    showModal('ข้อผิดพลาด', 'ไม่พบรายชื่อนักเรียนในชั้น ม.1/10 ในฐานข้อมูล Firebase. โปรดตรวจสอบข้อมูลใน Firestore.');
                    return;
                }

                studentsData = studentSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Sort students by ID (เลขที่)
                studentsData.sort((a, b) => parseInt(a.id) - parseInt(b.id));

                // Fetch today's attendance records
                const attendanceCol = collection(db, 'attendance');
                const qAttendance = query(attendanceCol, where('date', '==', todayDate));
                const attendanceSnapshot = await getDocs(qAttendance);

                attendanceSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    attendanceStatus[data.studentId] = {
                        status: data.status,
                        checkIns: data.checkIns || [] // Store checkIns from Firestore
                    };
                });

                renderStudentList();

            } catch (error) {
                console.error("Error fetching students or attendance:", error);
                studentListTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}</td></tr>`;
                showModal('ข้อผิดพลาด', `ไม่สามารถโหลดรายชื่อนักเรียนได้: ${error.message}`);
            }
        }

        // Function to render/re-render the student list table
        function renderStudentList() {
            studentListTableBody.innerHTML = ''; // Clear existing rows

            studentsData.forEach((student, index) => {
                // ถ้ายังไม่มีสถานะสำหรับวันนี้ ให้ตั้งค่าเริ่มต้นเป็น 'มา'
                const currentStatus = attendanceStatus[student.id]?.status || 'มา'; 
                // ตรวจสอบและตั้งค่าเริ่มต้นใน attendanceStatus ด้วย
                if (!attendanceStatus[student.id]) {
                    attendanceStatus[student.id] = { status: 'มา', checkIns: [] };
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';

                row.innerHTML = `
                    <td class="py-3 px-4 text-sm text-gray-800 font-medium">${student.id}</td>
                    <td class="py-3 px-4 text-sm text-gray-800">${student.name}</td>
                    <td class="py-3 px-4 text-sm">
                        <div class="flex flex-wrap gap-2 items-center">
                            <label class="inline-flex items-center">
                                <input type="radio" name="status-${student.id}" value="มา" 
                                    ${currentStatus === 'มา' ? 'checked' : ''} 
                                    class="form-radio h-4 w-4 text-green-600" data-student-id="${student.id}" onchange="updateStatus(this)">
                                <span class="ml-2 text-green-700">มา</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="status-${student.id}" value="ลา" 
                                    ${currentStatus === 'ลา' ? 'checked' : ''} 
                                    class="form-radio h-4 w-4 text-yellow-600" data-student-id="${student.id}" onchange="updateStatus(this)">
                                <span class="ml-2 text-yellow-700">ลา</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="status-${student.id}" value="ขาด" 
                                    ${currentStatus === 'ขาด' ? 'checked' : ''} 
                                    class="form-radio h-4 w-4 text-red-600" data-student-id="${student.id}" onchange="updateStatus(this)">
                                <span class="ml-2 text-red-700">ขาด</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="status-${student.id}" value="สาย" 
                                    ${currentStatus === 'สาย' ? 'checked' : ''} 
                                    class="form-radio h-4 w-4 text-orange-600" data-student-id="${student.id}" onchange="updateStatus(this)">
                                <span class="ml-2 text-orange-700">สาย</span>
                            </label>
                            <!-- ปุ่ม Check-in จะแสดงเมื่อสถานะเป็น 'มา' หรือ 'สาย' และจะเพิ่มเวลา Check-in ลงในข้อมูลภายใน -->
                            ${currentStatus === 'มา' || currentStatus === 'สาย' ? 
                                `<button class="ml-2 bg-blue-500 text-white text-xs px-2 py-1 rounded-md hover:bg-blue-600 transition duration-150" 
                                         onclick="addCheckIn('${student.id}')">
                                    + เช็คอิน
                                </button>` : ''}
                        </div>
                    </td>
                    <!-- Removed 'เวลา Check-in' display column -->
                `;
                studentListTableBody.appendChild(row);
            });
        }

        // Global function for event handlers (because they are called from inline HTML)
        window.updateStatus = function(radio) {
            const studentId = radio.dataset.studentId;
            const newStatus = radio.value;

            // Update local attendanceStatus
            attendanceStatus[studentId] = attendanceStatus[studentId] || { status: '', checkIns: [] };
            attendanceStatus[studentId].status = newStatus;

            // Clear check-ins if status is not 'มา' or 'สาย'
            if (newStatus !== 'มา' && newStatus !== 'สาย') {
                attendanceStatus[studentId].checkIns = [];
            }
            
            renderStudentList(); // Re-render to show/hide + Check-in button
        };

        window.addCheckIn = function(studentId) {
            const currentTime = getCurrentTimeString();
            attendanceStatus[studentId] = attendanceStatus[studentId] || { status: '', checkIns: [] };
            
            // ตรวจสอบว่าสถานะปัจจุบันเป็น 'มา' หรือ 'สาย' ก่อนเพิ่ม Check-in
            if (attendanceStatus[studentId].status !== 'มา' && attendanceStatus[studentId].status !== 'สาย') {
                attendanceStatus[studentId].status = 'มา'; // ตั้งสถานะเป็น 'มา' หากยังไม่ใช่
            }

            // เพิ่มเวลา Check-in หากยังไม่มีในนาทีปัจจุบัน
            if (!attendanceStatus[studentId].checkIns.includes(currentTime)) {
                attendanceStatus[studentId].checkIns.push(currentTime);
                attendanceStatus[studentId].checkIns.sort(); // จัดเรียงเวลา Check-in
                renderStudentList(); // Re-render เพื่ออัปเดตสถานะและปุ่ม
            }
        };

        // Function to send attendance data to backend and trigger LINE notification
        confirmButton.addEventListener('click', async () => {
            confirmButton.disabled = true;
            confirmButton.textContent = 'กำลังยืนยัน...';
            showModal('กำลังดำเนินการ', 'กำลังบันทึกข้อมูลการเช็คชื่อและส่งแจ้งเตือน LINE...');

            const todayDate = getTodayDateString();
            let allRecordsSent = true;

            // 1. Prepare data: Ensure 'มา' or 'สาย' statuses have at least one check-in
            const studentsToProcess = studentsData.map(student => {
                const record = attendanceStatus[student.id] || { status: 'ยังไม่เช็คชื่อ', checkIns: [] };
                
                // If status is 'มา' or 'สาย' but no check-ins, add one automatically
                if ((record.status === 'มา' || record.status === 'สาย') && record.checkIns.length === 0) {
                    const autoCheckInTime = getCurrentTimeString();
                    record.checkIns.push(autoCheckInTime);
                    console.log(`Auto-added check-in for ${student.name} (${student.id}): ${autoCheckInTime}`);
                }
                return {
                    studentId: student.id,
                    studentName: student.name,
                    date: todayDate,
                    status: record.status,
                    checkIns: record.checkIns
                };
            });


            // 2. Send individual attendance records to backend
            for (const record of studentsToProcess) {
                try {
                    const response = await fetch(`${BACKEND_API_BASE_URL}/attendance/record`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(record),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error(`Failed to record attendance for ${record.studentName}:`, errorData);
                        allRecordsSent = false;
                        // Don't break, try to send other records
                    }
                } catch (error) {
                    console.error(`Error sending attendance for ${record.studentName}:`, error);
                    allRecordsSent = false;
                    // Don't break
                }
            }

            // 3. Trigger LINE summary and notification on backend
            if (allRecordsSent) {
                try {
                    const summaryResponse = await fetch(`${BACKEND_API_BASE_URL}/attendance/summary-and-notify`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ date: todayDate }), // Send date to backend for summary
                    });

                    if (summaryResponse.ok) {
                        showModal('สำเร็จ!', 'บันทึกการเช็คชื่อและส่งแจ้งเตือน LINE เรียบร้อยแล้ว');
                    } else {
                        const errorData = await summaryResponse.json();
                        console.error('Failed to send LINE summary:', errorData);
                        showModal('ข้อผิดพลาด', `บันทึกการเช็คชื่อสำเร็จ แต่ไม่สามารถส่งแจ้งเตือน LINE ได้: ${errorData.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Error triggering LINE summary:', error);
                    showModal('ข้อผิดพลาด', `บันทึกการเช็คชื่อสำเร็จ แต่เกิดข้อผิดพลาดในการเชื่อมต่อเพื่อส่งแจ้งเตือน LINE: ${error.message}`);
                }
            } else {
                showModal('ข้อผิดพลาดบางส่วน', 'มีบางรายการเช็คชื่อที่ไม่สามารถบันทึกได้ โปรดตรวจสอบ Console สำหรับรายละเอียด');
            }

            confirmButton.disabled = false;
            confirmButton.textContent = 'ยืนยันการเช็คชื่อและแจ้งเตือน LINE';
            fetchStudents(); // Refresh data after submission
        });

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            currentDateSpan.textContent = new Date().toLocaleDateString('th-TH', { dateStyle: 'long' });
            fetchStudents();
        });
    </script>
</body>
</html>
